# Obsidian Plugin - Sync Contract & Data Models

**Version:** 1.0  
**Date:** January 15, 2026  
**Status:** ğŸ“‹ Specification

---

## Overview

This document defines the data models, sync rules, and mapping between Think Forge Chat and Obsidian.

---

## Core Concepts

### Sync Folder
A **Sync Folder** is a bidirectional link between:
- An Obsidian folder (within a vault)
- A Think Forge folder

The sync folder is the unit of synchronization. Items within synced folders are automatically synchronized based on the configured direction.

### Sync Direction

| Direction | Meaning |
|-----------|---------|
| `obsidian_to_tf` | Obsidian is source of truth |
| `tf_to_obsidian` | Think Forge is source of truth |
| `both` | Bidirectional, last-write-wins |

---

## Data Models

### SyncFolder

```typescript
interface SyncFolder {
  id: string;                    // Unique ID (generated by Obsidian plugin)
  obsidianPath: string;          // Relative path in vault (e.g., "Think Forge/Projects")
  obsidianVaultPath: string;     // Absolute vault path
  thinkForgeFolderId: string;    // Think Forge folder ID
  thinkForgeFolderName: string;  // Think Forge folder display name
  direction: 'obsidian_to_tf' | 'tf_to_obsidian' | 'both';
  created: string;               // ISO8601 timestamp
  lastSync: string | null;       // ISO8601 timestamp of last successful sync
  settings: SyncFolderSettings;
}

interface SyncFolderSettings {
  includeFrontmatter: boolean;   // Include YAML frontmatter in exports
  flattenTags: boolean;          // Flatten nested tags (default true)
  conflictResolution: 'last_write_wins' | 'create_duplicate';
}
```

### SyncedItem

```typescript
interface SyncedItem {
  id: string;                    // Unique sync ID
  obsidianNoteId: string | null; // Obsidian note ID (if exists in Obsidian)
  obsidianPath: string | null;   // Obsidian file path
  thinkForgeId: string | null;   // Think Forge item ID (if exists in TF)
  thinkForgeType: 'conversation' | 'forgedoc' | 'dockit';
  syncFolderId: string;          // Parent sync folder
  title: string;
  tags: string[];                // Flattened tags
  created: string;               // ISO8601
  modified: string;              // ISO8601
  lastSyncedAt: string | null;   // ISO8601
  syncStatus: 'synced' | 'pending' | 'conflict' | 'error';
  checksum: string;              // Content hash for change detection
}
```

### ObsidianNote

```typescript
interface ObsidianNote {
  id: string;                    // Obsidian internal ID
  title: string;                 // Filename without .md
  path: string;                  // Full path relative to vault
  content: string;               // Full markdown content
  frontmatter: Record<string, any> | null;  // Parsed YAML frontmatter
  tags: string[];                // Extracted tags (flattened)
  created: string;               // File creation time
  modified: string;              // File modification time
  size: number;                  // File size in bytes
}
```

### ThinkForgeItem

```typescript
interface ThinkForgeItem {
  id: string;
  type: 'conversation' | 'forgedoc' | 'dockit';
  title: string;
  content: string;               // Markdown content
  tags: string[];
  folderId: string;
  platform?: string;             // For conversations: chatgpt, claude, etc.
  url?: string;                  // Original URL
  created: string;
  modified: string;
  isDirty: boolean;              // Dirty flag for sync
}
```

---

## Tag Handling

### Flattening Rules

Obsidian nested tags are flattened for Think Forge compatibility:

| Obsidian Tag | Think Forge Tags |
|--------------|------------------|
| `#project` | `project` |
| `#project/alpha` | `project`, `alpha` |
| `#dev/frontend/react` | `dev`, `frontend`, `react` |

### Tag Extraction

**From Obsidian:**
1. Parse YAML frontmatter `tags` field
2. Extract inline `#tags` from content
3. Flatten nested tags
4. Deduplicate

**To Obsidian:**
1. Add to YAML frontmatter (if enabled)
2. Optionally add as inline tags at bottom of content

---

## Sync Rules

### Rule 1: Never Delete
Sync operations **never delete** items on either side. Deletion is always user-initiated.

### Rule 2: Conflict Resolution
When the same item is modified in both systems:

**Last Write Wins (default):**
```
if (obsidianModified > thinkForgeModified) {
  // Obsidian version overwrites Think Forge
} else {
  // Think Forge version overwrites Obsidian
}
```

**Create Duplicate (alternative):**
```
// Create new item with conflict marker
newTitle = originalTitle + " (conflict " + timestamp + ")"
```

### Rule 3: New Item Creation

**Obsidian â†’ Think Forge:**
- Note without Think Forge frontmatter ID â†’ Create new Forge Doc
- Note with Think Forge frontmatter ID â†’ Update existing item

**Think Forge â†’ Obsidian:**
- Item without Obsidian note ID â†’ Create new note
- Item with Obsidian note ID â†’ Update existing note

### Rule 4: Dirty Flag Integration

Think Forge already has `isDirty` flag for cloud sync. Obsidian sync hooks into same mechanism:

```
onItemModified(item) {
  item.isDirty = true;
  
  // Existing cloud sync checks isDirty
  // NEW: Obsidian sync also checks isDirty
  
  if (obsidianSyncEnabled && item.folderId in syncedFolders) {
    queueForObsidianSync(item);
  }
}
```

---

## Frontmatter Schema

When `includeFrontmatter` is enabled, exported notes include:

```yaml
---
id: tf-conv-12345
source: think-forge
type: conversation
platform: chatgpt
url: https://chatgpt.com/c/abc123
tags:
  - react
  - hooks
  - frontend
created: 2026-01-15T10:00:00Z
modified: 2026-01-15T10:30:00Z
synced: 2026-01-15T10:31:00Z
---
```

### Frontmatter Fields

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Think Forge item ID |
| `source` | string | Always `think-forge` |
| `type` | string | `conversation`, `forgedoc`, `dockit` |
| `platform` | string | AI platform (conversations only) |
| `url` | string | Original URL (conversations only) |
| `tags` | string[] | Item tags |
| `created` | ISO8601 | Original creation time |
| `modified` | ISO8601 | Last modification time |
| `synced` | ISO8601 | Last sync time |

---

## Conversation Export Format

### Single File Format (Default)

```markdown
---
id: tf-conv-12345
source: think-forge
type: conversation
platform: chatgpt
tags: [react, hooks]
created: 2026-01-15T10:00:00Z
---

# React Hooks Discussion

**Platform:** ChatGPT  
**Date:** January 15, 2026

---

## Question 1
How do I use useEffect?

### Answer
useEffect is a React Hook that lets you synchronize a component with an external system...

---

## Question 2
What about cleanup?

### Answer
You can return a cleanup function from useEffect...
```

---

## Folder Metadata Modal

Per your requirement, a new **Folder Metadata Modal** will be created. This modal is generic (not Obsidian-specific) to support future plugins/APIs.

### Modal Data Model

```typescript
interface FolderMetadata {
  folderId: string;
  folderName: string;
  
  // Obsidian sync (if enabled)
  obsidianSync?: {
    enabled: boolean;
    syncFolderId: string;
    obsidianPath: string;
    direction: 'obsidian_to_tf' | 'tf_to_obsidian' | 'both';
    lastSync: string | null;
  };
  
  // Future: Other integrations
  // notionSync?: { ... };
  // googleDriveSync?: { ... };
}
```

### Modal Features
- View folder stats (item count, last modified)
- Configure Obsidian sync for this folder
- View sync status and last sync time
- Manual sync button
- Future: Add other integrations

---

## Branch Chat Integration

Per your requirement, the branch chat context menu will include an Obsidian option:

### Context Menu Addition

```
[Branch Chat Icon] - Left click: Open branch modal
                   - Right click: Context menu
                     â”œâ”€â”€ Branch to new chat
                     â”œâ”€â”€ Copy to clipboard
                     â”œâ”€â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                     â””â”€â”€ Send to Obsidian   â† NEW
```

### Send to Obsidian Flow

1. User right-clicks branch icon
2. Selects "Send to Obsidian"
3. If no Obsidian connection â†’ Show "Connect Obsidian in Settings" message
4. If connected â†’ Show folder picker (synced folders only)
5. On confirm â†’ POST to `/import/conversation`
6. Show success/error toast

---

## Storage Keys (Extension Side)

All Obsidian-related storage uses `obsidian_` prefix:

```typescript
const OBSIDIAN_STORAGE_KEYS = {
  // Feature toggle
  ENABLED: 'obsidian_enabled',
  
  // Connection
  PORT: 'obsidian_port',
  CONNECTED: 'obsidian_connected',
  LAST_STATUS_CHECK: 'obsidian_last_status_check',
  VAULT_NAME: 'obsidian_vault_name',
  
  // Sync state
  SYNC_FOLDERS: 'obsidian_sync_folders',      // SyncFolder[]
  LAST_SYNC: 'obsidian_last_sync',            // ISO8601
  PENDING_SYNC: 'obsidian_pending_sync',      // Item IDs queued for sync
  
  // Settings
  SETTINGS: 'obsidian_settings'               // User preferences
};
```

---

## Sync Flow Diagrams

### Auto Sync Flow (Think Forge â†’ Obsidian)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THINK FORGE CHAT                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. User edits Forge Doc                                        â”‚
â”‚          â†“                                                       â”‚
â”‚  2. Item marked isDirty = true                                  â”‚
â”‚          â†“                                                       â”‚
â”‚  3. Dirty flag handler checks:                                  â”‚
â”‚     - Is Obsidian enabled?                                      â”‚
â”‚     - Is item in a synced folder?                               â”‚
â”‚          â†“ (yes to both)                                        â”‚
â”‚  4. Queue item for Obsidian sync                                â”‚
â”‚          â†“                                                       â”‚
â”‚  5. Background worker processes queue                           â”‚
â”‚          â†“                                                       â”‚
â”‚  6. POST /notes to Obsidian plugin                              â”‚
â”‚          â†“                                                       â”‚
â”‚  7. Update lastSyncedAt, clear from queue                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OBSIDIAN PLUGIN                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  8. Receive POST /notes                                         â”‚
â”‚          â†“                                                       â”‚
â”‚  9. Check if note exists (by frontmatter ID)                    â”‚
â”‚          â†“                                                       â”‚
â”‚  10a. Exists â†’ Update file content                              â”‚
â”‚  10b. Not exists â†’ Create new .md file                          â”‚
â”‚          â†“                                                       â”‚
â”‚  11. Return success response                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Auto Sync Flow (Obsidian â†’ Think Forge)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OBSIDIAN PLUGIN                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. File watcher detects change in synced folder                â”‚
â”‚          â†“                                                       â”‚
â”‚  2. Record change in changes queue                              â”‚
â”‚          â†“                                                       â”‚
â”‚  3. Wait for extension to poll GET /sync/changes                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘ HTTP (polling)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THINK FORGE CHAT                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. Background polls GET /sync/changes (every N seconds)        â”‚
â”‚          â†“                                                       â”‚
â”‚  5. Receive list of changed notes                               â”‚
â”‚          â†“                                                       â”‚
â”‚  6. For each change:                                            â”‚
â”‚     - GET /notes/:id for full content                           â”‚
â”‚     - Check if Forge Doc exists (by frontmatter ID)             â”‚
â”‚     - Create or update Forge Doc                                â”‚
â”‚          â†“                                                       â”‚
â”‚  7. POST /sync/acknowledge                                      â”‚
â”‚          â†“                                                       â”‚
â”‚  8. Update local sync state                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling

### Connection Lost
- Extension shows "Obsidian Disconnected" in Settings
- Queued items remain in queue
- Automatic retry when connection restored

### Sync Conflict
- Default: Last write wins (silent)
- Optional: Create duplicate with "(conflict)" suffix
- Never lose data

### File System Errors
- Obsidian plugin catches and reports errors
- Extension shows toast notification
- Item remains in pending state


